<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliSummarize - Chat Summarizer & AI Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: #475569; /* slate-600 */
            color: #475569;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: #475569;
            color: #475569;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: #475569;
            color: #475569;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: #475569; }
            50%, 100% { background-color: #94a3b8; }
        }
        .prose {
            color: #334155;
        }
        .prose h3 {
             font-size: 1.1em;
             margin-bottom: 0.5em;
        }
        .prose ul {
            padding-left: 1.25rem;
            list-style-type: disc;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
        .prose strong {
            color: #1e293b;
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <div class="min-h-screen bg-slate-50 p-4 lg:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-200/80">
            <!-- Header -->
            <header class="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-5 sm:p-6 flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">IntelliSummarize</h1>
                    <p class="text-slate-300 text-sm md:text-base">Your AI-Powered Chat Analysis Tool</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center ring-1 ring-white/20">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-5 sm:p-8">
                <!-- Left Column: Chat Input & Summarizer -->
                <div class="flex flex-col space-y-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2.5 text-slate-500"></i>
                            1. Input Your Chat Log
                        </h2>
                        <div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                 <div class="relative" id="custom-select-container">
                                    <input type="hidden" id="chat-format-selector" value="generic">
                                    <button id="format-select-button" type="button" class="w-full h-full bg-slate-50 border border-slate-300 rounded-md py-2.5 px-3.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500 transition flex items-center justify-between text-left">
                                        <span id="selected-format-text" class="truncate">Generic (e.g., User1: Hello)</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform flex-shrink-0 ml-2"></i>
                                    </button>
                                    <div id="format-select-options" class="hidden absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg border border-slate-200/80 p-1">
                                        <a href="#" class="text-slate-700 block px-3 py-1.5 text-sm rounded-md hover:bg-slate-100" data-value="generic">Generic (e.g., User1: Hello)</a>
                                        <a href="#" class="text-slate-700 block px-3 py-1.5 text-sm rounded-md hover:bg-slate-100" data-value="whatsapp">WhatsApp (e.g., [10/22/25, 11:20 AM] John: Hi)</a>
                                        <a href="#" class="text-slate-700 block px-3 py-1.5 text-sm rounded-md hover:bg-slate-100" data-value="slack">Slack / Discord (e.g., username [11:20 AM])</a>
                                    </div>
                                </div>
                                <div>
                                    <label for="screenshot-input" class="w-full bg-slate-50 border border-slate-300 rounded-md py-2.5 px-3.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500 transition flex items-center justify-center text-left cursor-pointer hover:bg-slate-100 truncate">
                                        <i data-lucide="image-plus" class="w-4 h-4 text-slate-500 flex-shrink-0 mr-2"></i>
                                        <span id="attach-screenshot-text" class="truncate">Attach Screenshot</span>
                                    </label>
                                    <input type="file" id="screenshot-input" class="hidden" accept="image/*">
                                </div>
                            </div>
                            <div id="image-preview-container" class="hidden relative w-32 h-32 mb-3 rounded-md overflow-hidden border border-slate-200 shadow-sm">
                                <img id="image-preview" class="w-full h-full object-cover" src="">
                                <button id="remove-image-btn" class="absolute top-1 right-1 bg-black/60 text-white rounded-full p-0.5 hover:bg-black/80 transition-colors">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <textarea id="chat-input" class="w-full h-64 p-3.5 bg-slate-50 border border-slate-300 rounded-md resize-y focus:outline-none focus:ring-2 focus:ring-slate-500 transition" placeholder="Paste your chat conversation here..."></textarea>
                        </div>
                         <button id="summarize-btn" class="mt-4 w-full bg-slate-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-600 transition-all transform hover:scale-[1.02] flex items-center justify-center disabled:bg-slate-500 disabled:cursor-not-allowed disabled:scale-100">
                            <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                            Summarize Conversation
                        </button>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex-grow">
                        <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                           <i data-lucide="book-marked" class="w-5 h-5 mr-2.5 text-slate-500"></i>
                           2. Generated Summary
                        </h2>
                        <div class="w-full min-h-[16rem] h-full p-3.5 bg-slate-50 border border-slate-300 rounded-md overflow-y-auto prose max-w-none">
                            <div id="summary-placeholder" class="text-slate-400 h-full flex flex-col items-center justify-center text-center">
                                <i data-lucide="clipboard-list" class="w-12 h-12 mb-3 text-slate-300"></i>
                                <p class="font-medium">Your summary will appear here.</p>
                                <p class="text-xs">Click the "Summarize" button above to start.</p>
                            </div>
                            <div id="summary-loader" class="hidden items-center justify-center h-full">
                                <div class="text-center">
                                    <div class="dot-flashing mx-auto"></div>
                                    <p class="mt-4 text-sm text-slate-500">Analyzing conversation...</p>
                                </div>
                            </div>
                            <div id="summary-output" class="hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: AI Chatbot -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col h-[85vh] max-h-[860px]">
                    <h2 class="text-lg font-semibold text-slate-800 mb-1 flex items-center">
                        <i data-lucide="message-circle" class="w-5 h-5 mr-2.5 text-slate-500"></i>
                        3. Ask the AI Bot
                    </h2>
                    <p class="text-sm text-slate-500 mb-4">Ask questions about the conversation after generating a summary.</p>
                    <div id="chatbot-container" class="flex-grow bg-slate-50 border border-slate-200 rounded-lg overflow-y-auto p-4 space-y-4 chat-container">
                        <!-- Initial bot message -->
                        <div class="flex items-start gap-3">
                            <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0 ring-4 ring-white">
                               <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex flex-col w-full max-w-[320px] leading-1.5 p-3.5 border-slate-200 bg-slate-200 rounded-e-xl rounded-es-xl">
                                <p class="text-sm font-normal text-slate-800">Hello! Once you've summarized a chat, you can ask me questions about it here.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <input type="text" id="chatbot-input" class="flex-grow p-3.5 border border-slate-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-slate-500 disabled:bg-slate-200 transition" placeholder="Ask a follow-up question..." disabled>
                        <button id="chatbot-send-btn" class="bg-slate-700 text-white p-3.5 rounded-r-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-slate-600 disabled:bg-slate-500 disabled:cursor-not-allowed flex items-center justify-center w-16 h-[54px] transition-colors">
                           <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const chatInput = document.getElementById('chat-input');
            const summarizeBtn = document.getElementById('summarize-btn');
            
            const summaryPlaceholder = document.getElementById('summary-placeholder');
            const summaryLoader = document.getElementById('summary-loader');
            const summaryOutput = document.getElementById('summary-output');
            
            const chatbotContainer = document.getElementById('chatbot-container');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotSendBtn = document.getElementById('chatbot-send-btn');
            
            const chatFormatSelector = document.getElementById('chat-format-selector');

            let originalChatContext = "";
            let currentImageData = null;

            // --- Image Upload Logic ---
            const screenshotInput = document.getElementById('screenshot-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');
            const attachScreenshotText = document.getElementById('attach-screenshot-text');

            screenshotInput.addEventListener('change', () => {
                const file = screenshotInput.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentImageData = e.target.result.split(',')[1]; // Get base64 part
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                        attachScreenshotText.textContent = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeImageBtn.addEventListener('click', () => {
                currentImageData = null;
                screenshotInput.value = ''; // Reset file input
                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
                attachScreenshotText.textContent = 'Attach Screenshot';
                lucide.createIcons();
            });

            // --- Custom Select Dropdown Logic ---
            const customSelectContainer = document.getElementById('custom-select-container');
            const formatSelectButton = document.getElementById('format-select-button');
            const selectedFormatText = document.getElementById('selected-format-text');
            const formatSelectOptions = document.getElementById('format-select-options');
            const chevronIcon = formatSelectButton.querySelector('svg');

            formatSelectButton.addEventListener('click', (e) => {
                e.stopPropagation();
                formatSelectOptions.classList.toggle('hidden');
                chevronIcon.classList.toggle('rotate-180');
            });

            formatSelectOptions.querySelectorAll('a').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const value = option.dataset.value;
                    const text = option.textContent;

                    chatFormatSelector.value = value; // Set hidden input value
                    selectedFormatText.textContent = text; // Update button text

                    formatSelectOptions.classList.add('hidden'); // Close dropdown
                    chevronIcon.classList.remove('rotate-180');
                });
            });

            window.addEventListener('click', () => {
                if (!formatSelectOptions.classList.contains('hidden')) {
                    formatSelectOptions.classList.add('hidden');
                    chevronIcon.classList.remove('rotate-180');
                }
            });
            
            // --- NEW, SECURE Gemini API Call Function ---
const callGeminiAPI = async (prompt, imageData = null) => {
    // This is the path to our Netlify Function
    const functionUrl = '/.netlify/functions/summarize';

    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, imageData })
        });

        if (!response.ok) {
            throw new Error(`Function error! status: ${response.status}`);
        }

        const result = await response.json();
        const candidate = result.candidates?.[0];
        if (candidate && candidate.content?.parts?.[0]?.text) {
            return candidate.content.parts[0].text.replace(/<br>/g, '\n').replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>');
        } else {
            console.error("Invalid response from function:", result);
            throw new Error("Invalid response structure from the function.");
        }
    } catch (error) {
        console.error(`API call failed:`, error);
        return "Error: Could not get a response from the AI. Please try again later.";
    }
};
            
            // --- Summarization Logic ---
            const handleSummarize = async () => {
                const chatText = chatInput.value.trim();
                if (!chatText && !currentImageData) {
                    alert('Please paste a chat conversation or attach a screenshot first.');
                    return;
                }

                summarizeBtn.disabled = true;
                summarizeBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span class="ml-2">Analyzing...</span>`;
                summaryPlaceholder.classList.add('hidden');
                summaryOutput.classList.add('hidden');
                summaryLoader.classList.remove('hidden');
                summaryLoader.classList.add('flex');

                const chatFormat = selectedFormatText.textContent;
                let summarizationPrompt = `
                    You are an expert at analyzing and summarizing conversations.
                    Summarize the following chat conversation, which is in the format of "${chatFormat}".
                    
                    Your summary should be clear, concise, and structured. Use Markdown for formatting.
                    Include the following sections with bolded titles (e.g., **Key Topics Discussed**):
                    - Key Topics Discussed: A bulleted list of the main subjects.
                    - Main Outcomes & Decisions: A bulleted list of any conclusions, decisions, or action items.
                    - Overall Sentiment: A brief description of the mood of the conversation (e.g., positive, negative, neutral, collaborative).

                    Here is the conversation:
                    ---
                    ${chatText}
                    ---
                `;

                if (currentImageData) {
                    summarizationPrompt += `\n\nThe user has also attached a screenshot of the conversation. Use both the text and the screenshot to create the most accurate summary possible. The screenshot provides visual context that may not be in the text. If there is no text provided, summarize the screenshot.`;
                }

                const summary = await callGeminiAPI(summarizationPrompt, currentImageData);
                
                summaryOutput.innerHTML = summary; 
                summaryLoader.classList.add('hidden');
                summaryLoader.classList.remove('flex');
                summaryOutput.classList.remove('hidden');

                originalChatContext = chatText;
                chatbotInput.disabled = false;
                chatbotSendBtn.disabled = false;
                chatbotInput.placeholder = "Ask about the conversation...";
                
                summarizeBtn.disabled = false;
                summarizeBtn.innerHTML = `<i data-lucide="zap" class="w-5 h-5 mr-2"></i> Summarize Conversation`;
                lucide.createIcons();
            };

            // --- Chatbot Logic ---
            const handleChatbotSend = async () => {
                const userQuery = chatbotInput.value.trim();
                if (!userQuery) return;
                
                appendMessage(userQuery, 'user');
                chatbotInput.value = '';
                chatbotInput.disabled = true;
                chatbotSendBtn.disabled = true;

                const typingIndicator = createTypingIndicator();
                chatbotContainer.appendChild(typingIndicator);
                chatbotContainer.scrollTop = chatbotContainer.scrollHeight;

                let chatbotPrompt = `
                    You are a helpful AI assistant tasked with answering questions about a specific chat conversation.
                    Use ONLY the provided conversation context to answer the user's question. Do not make up information.
                    If the answer is not in the conversation, say "The answer to that question isn't available in the provided chat log."

                    CONVERSATION CONTEXT:
                    ---
                    ${originalChatContext}
                    ---
                    
                    USER'S QUESTION: "${userQuery}"
                `;

                if (currentImageData) {
                    chatbotPrompt += `\n\nAlso consider the attached conversation screenshot when answering the question. The image provides important context.`;
                }

                const botResponse = await callGeminiAPI(chatbotPrompt, currentImageData);
                
                typingIndicator.remove();
                appendMessage(botResponse, 'bot');
                
                chatbotInput.disabled = false;
                chatbotSendBtn.disabled = false;
                chatbotInput.focus();
            };

            const appendMessage = (text, sender) => {
                const messageWrapper = document.createElement('div');
                let messageHtml = '';

                if (sender === 'user') {
                     messageHtml = `
                        <div class="flex items-start gap-3 justify-end">
                            <div class="flex flex-col w-full max-w-[320px] leading-1.5 p-3.5 border-slate-200 bg-slate-700 text-white rounded-s-xl rounded-ee-xl">
                                <p class="text-sm font-normal">${text}</p>
                            </div>
                             <div class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0 ring-4 ring-white">
                               <i data-lucide="user" class="w-5 h-5 text-slate-600"></i>
                            </div>
                        </div>`;
                } else {
                    messageHtml = `
                        <div class="flex items-start gap-3">
                            <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0 ring-4 ring-white">
                               <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex flex-col w-full max-w-[320px] leading-1.5 p-3.5 border-slate-200 bg-slate-200 rounded-e-xl rounded-es-xl">
                                <p class="text-sm font-normal text-slate-800">${text}</p>
                            </div>
                        </div>`;
                }
                
                messageWrapper.innerHTML = messageHtml;
                chatbotContainer.appendChild(messageWrapper);
                chatbotContainer.scrollTop = chatbotContainer.scrollHeight;
                lucide.createIcons();
            };
            
            const createTypingIndicator = () => {
                const typingWrapper = document.createElement('div');
                typingWrapper.id = 'typing-indicator';
                typingWrapper.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0 ring-4 ring-white">
                           <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="flex items-center space-x-2 p-3.5 bg-slate-200 rounded-e-xl rounded-es-xl">
                            <div class="dot-flashing"></div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return typingWrapper;
            };

            // --- Event Listeners ---
            summarizeBtn.addEventListener('click', handleSummarize);
            chatbotSendBtn.addEventListener('click', handleChatbotSend);
            chatbotInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !chatbotInput.disabled) {
                    e.preventDefault();
                    handleChatbotSend();
                }
            });
        });
    </script>
</body>
</html>

